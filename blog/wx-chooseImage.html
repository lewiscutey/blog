<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ä¸€æ–‡å½»åº•å¼„æ‡‚wx.chooseImage | HOME</title>
    <meta name="description" content="è§£å†³å¾®ä¿¡å°ç¨‹åºä¸­web-viewé‡Œä½¿ç”¨chooseImage">
    <link rel="icon" href="/blog/favicon.ico">
    <meta name="keywords" content="web-view,å°ç¨‹åº,chooseImage">
    <link rel="preload" href="/blog/assets/css/0.styles.03f43f65.css" as="style"><link rel="preload" href="/blog/assets/js/app.426b1919.js" as="script"><link rel="preload" href="/blog/assets/js/8.723e2475.js" as="script"><link rel="preload" href="/blog/assets/js/3.79418191.js" as="script"><link rel="preload" href="/blog/assets/js/16.d48bf774.js" as="script"><link rel="preload" href="/blog/assets/js/19.ff47a288.js" as="script"><link rel="preload" href="/blog/assets/js/13.7908793c.js" as="script"><link rel="preload" href="/blog/assets/js/68.f115d1bc.js" as="script"><link rel="preload" href="/blog/assets/js/5.da195e96.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.55a543e4.js"><link rel="prefetch" href="/blog/assets/js/11.e5597df6.js"><link rel="prefetch" href="/blog/assets/js/12.b7ba11c7.js"><link rel="prefetch" href="/blog/assets/js/14.4410875d.js"><link rel="prefetch" href="/blog/assets/js/15.b657430a.js"><link rel="prefetch" href="/blog/assets/js/17.eeefbc07.js"><link rel="prefetch" href="/blog/assets/js/18.010cd5bc.js"><link rel="prefetch" href="/blog/assets/js/20.d0f52bb3.js"><link rel="prefetch" href="/blog/assets/js/21.9bea050c.js"><link rel="prefetch" href="/blog/assets/js/22.ee11d625.js"><link rel="prefetch" href="/blog/assets/js/23.6e634148.js"><link rel="prefetch" href="/blog/assets/js/24.e0f856db.js"><link rel="prefetch" href="/blog/assets/js/25.f97f7d33.js"><link rel="prefetch" href="/blog/assets/js/26.7681393f.js"><link rel="prefetch" href="/blog/assets/js/27.102f400b.js"><link rel="prefetch" href="/blog/assets/js/28.46c69e24.js"><link rel="prefetch" href="/blog/assets/js/29.bb64475f.js"><link rel="prefetch" href="/blog/assets/js/30.12416738.js"><link rel="prefetch" href="/blog/assets/js/31.7cc64602.js"><link rel="prefetch" href="/blog/assets/js/32.175d94de.js"><link rel="prefetch" href="/blog/assets/js/33.89a17daf.js"><link rel="prefetch" href="/blog/assets/js/34.a0106064.js"><link rel="prefetch" href="/blog/assets/js/35.970f9d7e.js"><link rel="prefetch" href="/blog/assets/js/36.fa8d9d4e.js"><link rel="prefetch" href="/blog/assets/js/37.93b81ade.js"><link rel="prefetch" href="/blog/assets/js/38.f242f2da.js"><link rel="prefetch" href="/blog/assets/js/39.91d1d0fb.js"><link rel="prefetch" href="/blog/assets/js/4.acd5b20f.js"><link rel="prefetch" href="/blog/assets/js/40.ec8fc8a2.js"><link rel="prefetch" href="/blog/assets/js/41.51829cee.js"><link rel="prefetch" href="/blog/assets/js/42.5614ec93.js"><link rel="prefetch" href="/blog/assets/js/43.eb03efc3.js"><link rel="prefetch" href="/blog/assets/js/44.c9e2f6ff.js"><link rel="prefetch" href="/blog/assets/js/45.0a9bbd19.js"><link rel="prefetch" href="/blog/assets/js/46.27f8e029.js"><link rel="prefetch" href="/blog/assets/js/47.1e0af253.js"><link rel="prefetch" href="/blog/assets/js/48.a7d6b692.js"><link rel="prefetch" href="/blog/assets/js/49.d8dfe89c.js"><link rel="prefetch" href="/blog/assets/js/50.c134af69.js"><link rel="prefetch" href="/blog/assets/js/51.f1cb3058.js"><link rel="prefetch" href="/blog/assets/js/52.fb7584dc.js"><link rel="prefetch" href="/blog/assets/js/53.5e6bf0ad.js"><link rel="prefetch" href="/blog/assets/js/54.a139237b.js"><link rel="prefetch" href="/blog/assets/js/55.2c8c1bd1.js"><link rel="prefetch" href="/blog/assets/js/56.d09c9904.js"><link rel="prefetch" href="/blog/assets/js/57.ac762da0.js"><link rel="prefetch" href="/blog/assets/js/58.84bdcdb4.js"><link rel="prefetch" href="/blog/assets/js/59.d6c177ba.js"><link rel="prefetch" href="/blog/assets/js/6.acfbb48a.js"><link rel="prefetch" href="/blog/assets/js/60.93b65c4d.js"><link rel="prefetch" href="/blog/assets/js/61.f562ba6c.js"><link rel="prefetch" href="/blog/assets/js/62.3eb3a491.js"><link rel="prefetch" href="/blog/assets/js/63.5175822a.js"><link rel="prefetch" href="/blog/assets/js/64.fcc0d5d9.js"><link rel="prefetch" href="/blog/assets/js/65.681bdc18.js"><link rel="prefetch" href="/blog/assets/js/66.85152f7f.js"><link rel="prefetch" href="/blog/assets/js/67.b6ff2ed4.js"><link rel="prefetch" href="/blog/assets/js/69.0259fb8a.js"><link rel="prefetch" href="/blog/assets/js/7.1e8f103c.js"><link rel="prefetch" href="/blog/assets/js/70.176336c8.js"><link rel="prefetch" href="/blog/assets/js/9.123bc00f.js"><link rel="prefetch" href="/blog/assets/js/vendors~flowchart.9809e798.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.03f43f65.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme"><header class="navbar"><div class="nav-header"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><img src="/blog/img/logo.png" class="logo"> <span class="site-name can-hide">
        HOME
      </span></a> <nav class="nav-links can-hide"><ul class="nav-ul"><li class="nav-item"><a href="/blog/" class="nav-link">Blog</a></li><li class="nav-item"><a href="/blog/about/" class="nav-link">About</a></li><li class="nav-item"><a href="/blog/tag/" class="nav-link">Tags</a></li><li class="nav-item"><a href="http://www.cnblogs.com/lewiscutey/" target="_blank" rel="noopener noreferrer" class="nav-link">CSDN</a></li><li class="nav-item"><a href="https://github.com/lewiscutey" target="_blank" rel="noopener noreferrer" class="nav-link">Github</a></li></ul></nav> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header> <div class="sidebar-mask"></div> <!----> <div class="layout-container"><div class="main"><div class="layout-inner"><div class="card"><div class="content-header"><h1 class="page-title">ä¸€æ–‡å½»åº•å¼„æ‡‚wx.chooseImage</h1> <span class="page-timestamp">2019-06-07 10:32:06</span></div> <div class="content default"><p>è¿™ä¸ªéœ€æ±‚åšä¸‹æ¥å‚è€ƒäº†ä¸å°‘æ–‡ç« ï¼Œå…¶å®å¤§å¤šéƒ½æ˜¯ä¸€çŸ¥åŠè§£ï¼Œæ¯ä¸ªäººé‡åˆ°çš„é—®é¢˜ä¸åŒï¼Œè¿™ç¯‡æ–‡ç« å¯ä»¥è¯´å½»åº•è§£å†³<code>wx.chooseImage</code>çš„å„ç§ç–‘éš¾æ‚ç—‡ï¼Œä¸€æ­¥åˆ°ä½,å› æ­¤è¶ç€ä»Šå¤©ä¼‘æ¯æŠŠæ•´ä¸ªè¿‡ç¨‹è®°å½•ä¸‹æ¥ï¼Œåˆ†äº«ç»™ä¹‹åæœ‰éœ€è¦çš„å„ä½åŒè¡Œï¼
</p> <blockquote><p>æœ€è¿‘åœ¨åšä¸€ä¸ªå¤æ‚çš„è·¨äº”ç«¯ï¼ˆPCã€H5ã€å°ç¨‹åºã€iOSã€androidï¼‰çš„éœ€æ±‚ï¼Œå†æ—¶å°†è¿‘ä¸¤ä¸ªå¤šæœˆï¼Œå…¶ä¸­é…¸ç”œè‹¦è¾£å†·æš–è‡ªçŸ¥ï¼Œè¿‘æ—¥ç»ˆäºå¯ä»¥å°æ¿ä¸Šçº¿ï¼Œå›å¿†æ•´ä¸ªå¼€å‘è¿‡ç¨‹ï¼Œæ·±å‘ä¸æ–­ï¼Œæ”¶è·é¢‡å¤šï¼Œä»Šå¤©å…ˆåˆ†äº«ä¸€ä¸‹åœ¨å¾®ä¿¡å°ç¨‹åºçš„web-viewé‡Œé€‰å–ç…§ç‰‡çš„åŠŸèƒ½ï¼Œæ­¤æ–‡å®Œæ•´çš„è®°å½•æ•´ä¸ªå¼€å‘è¿‡ç¨‹ï¼Œå½»åº•è§£å†³å„ç§ç–‘éš¾æ‚ç—‡ã€‚</p></blockquote> <h2 id="æ·±åº¦è°ƒç ”"><a href="#æ·±åº¦è°ƒç ”" aria-hidden="true" class="header-anchor">#</a> æ·±åº¦è°ƒç ”</h2> <p>å› ä¸ºè·¨ç«¯æ‰€ä»¥æœ€å¼€å§‹ä½¿ç”¨äº†<code>&lt;input type=&quot;file&quot; accept=&quot;image/*&quot; capture=&quot;camera&quot;&gt;</code>çš„æ–¹å¼ï¼Œç®€å•ç²—æš´å¯ä½¿ç”¨ï¼Œäº”ç«¯å‹‰å¼ºéƒ½å¯ä»¥æ‰“ä¸ªåŠæ ¼åˆ†ï¼Œä¸€ç›´åˆ°è”è°ƒç»“æŸPMæ£€æµ‹æ—¶è¯´ä½“éªŒå¤ªå·®äº†ï¼Œè¶ç€è¿˜æœ‰æ—¶é—´ï¼ˆå…¶å®æˆ‘ä¹Ÿçœ‹ä¸ä¸‹å»ï¼‰ï¼Œç´¢æ€§å°±æŒ‰PMçš„è¦æ±‚æ¥ï¼Œå¼€å§‹è®¡åˆ’è°ƒç”¨åŸç”Ÿçš„ï¼Œå› ä¸ºå®¢æˆ·ç«¯ä¹‹å‰å·²ç»æä¾›äº†è¿™æ ·çš„<strong>bridge</strong>ï¼Œæ‰€ä»¥å’Œå®¢æˆ·ç«¯çš„å¤´åƒè°ƒè¯•è½»æ¾å®Œæˆï¼Œå‰©ä¸‹çš„å°ç¨‹åºå†ç»ä¸‡åƒç£¨éš¾ï¼Œæœ€ç»ˆå®Œç¾è°¢å¹•ã€‚</p> <p>é¦–å…ˆæ²¡æœ‰åšè¿‡è¿™æ–¹é¢çš„ç»éªŒï¼Œä¸¤çœ¼ä¸€æŠ¹é»‘ï¼Œç”±äºæ˜¯æŠŠH5é¡µé¢åµŒå¥—åœ¨å°ç¨‹åºçš„<strong>web-view</strong>é‡Œï¼Œæ‰€ä»¥ç›´æ¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œå°ç¨‹åºå‘web-viewæä¾›äº†ä¸‰åå¤šä¸ªAPI-<a href="https://developers.weixin.qq.com/miniprogram/dev/component/web-view.html" target="_blank" rel="noopener noreferrer">è¯¦æƒ…æ–‡æ¡£<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ã€‚è‡³æ­¤ä»¥ä¸ºå¯ä»¥è½»æ¾æå®šï¼Œäºæ˜¯å¼€å§‹äº†ä¸æ–­çš„è¶Ÿå‘ã€‚ã€‚ã€‚</p> <h2 id="æŒ‰æ­¥å¼€å‘"><a href="#æŒ‰æ­¥å¼€å‘" aria-hidden="true" class="header-anchor">#</a> æŒ‰æ­¥å¼€å‘</h2> <p>åˆšå¼€å§‹ç›´æ¥åœ¨H5é‡Œä½¿ç”¨äº†<code>wx.chooseImage</code>,å‘ç°åœ¨å¼€å‘è€…å·¥å…·ä¸­ä¸æ–­çš„æŠ¥é”™<code>the permission value is offline verifying</code>,æ…¢æ…¢å¼€å§‹æœç´¢æ‰å‘ç°åœ¨å°ç¨‹åºçš„web-viewé‡Œä¹Ÿå¿…é¡»ä½¿ç”¨<strong>jweixin</strong>,å…¶å®å°±æ˜¯ä¸ªå…¬ä¼—å·ç½‘é¡µï¼Œæ¥ä¸‹æ¥å¼€å§‹æŒ‰<a href="https://qydev.weixin.qq.com/wiki/index.php?title=%E5%BE%AE%E4%BF%A1JS-SDK%E6%8E%A5%E5%8F%A3#.E6.AD.A5.E9.AA.A4.E4.B8.80.EF.BC.9A.E5.BC.95.E5.85.A5JS.E6.96.87.E4.BB.B6" target="_blank" rel="noopener noreferrer">è¿™å¥—æµç¨‹<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>èµ°:</p> <ol><li>å¼•å…¥JSæ–‡ä»¶</li></ol> <div class="language- extra-class"><pre class="language-text"><code>// æ¨èä½¿ç”¨1.3.2ä»¥ä¸Šçš„ç‰ˆæœ¬ï¼Œä¹‹å‰çš„ç‰ˆæœ¬å¾ˆå¤šå‘ğŸ˜­
https://res.wx.qq.com/open/js/jweixin-1.3.2.js
// æˆ‘æ˜¯ç›´æ¥ç”¨çš„npmåŒ…ï¼Œç›®å‰åŸºäº1.4.0-testçš„ç‰ˆæœ¬
npm install weixin-js-sdk
</code></pre></div><ol start="2"><li>é€šè¿‡configæ¥å£æ³¨å…¥æƒé™éªŒè¯é…ç½®</li></ol> <div class="language-javascript extra-class"><pre class="language-javascript"><code>wx<span class="token punctuation">.</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    debug<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// å¼€å¯è°ƒè¯•æ¨¡å¼,è°ƒç”¨çš„æ‰€æœ‰apiçš„è¿”å›å€¼ä¼šåœ¨å®¢æˆ·ç«¯alertå‡ºæ¥ï¼Œè‹¥è¦æŸ¥çœ‹ä¼ å…¥çš„å‚æ•°ï¼Œå¯ä»¥åœ¨pcç«¯æ‰“å¼€ï¼Œå‚æ•°ä¿¡æ¯ä¼šé€šè¿‡logæ‰“å‡ºï¼Œä»…åœ¨pcç«¯æ—¶æ‰ä¼šæ‰“å°ã€‚</span>
    appId<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token comment">// å¿…å¡«ï¼Œå¾®ä¿¡å…¬ä¼—å·çš„å”¯ä¸€æ ‡è¯†ï¼Œæ­¤å¤„å¡«å†™å…¬ä¼—å·çš„appId</span>
    timestamp<span class="token punctuation">:</span> <span class="token punctuation">,</span> <span class="token comment">// å¿…å¡«ï¼Œç”Ÿæˆç­¾åçš„æ—¶é—´æˆ³</span>
    nonceStr<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span> <span class="token comment">// å¿…å¡«ï¼Œç”Ÿæˆç­¾åçš„éšæœºä¸²</span>
    signature<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span><span class="token comment">// å¿…å¡«ï¼Œç­¾å</span>
    jsApiList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token comment">// å¿…å¡«ï¼Œéœ€è¦ä½¿ç”¨çš„JSæ¥å£åˆ—è¡¨ï¼Œæ‰€æœ‰JSæ¥å£åˆ—è¡¨è§é™„å½•2</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="3"><li>é€šè¿‡readyæ¥å£å¤„ç†æˆåŠŸéªŒè¯</li></ol> <div class="language- extra-class"><pre class="language-text"><code>wx.ready(function(){
    // configä¿¡æ¯éªŒè¯åä¼šæ‰§è¡Œreadyæ–¹æ³•ï¼Œæ‰€æœ‰æ¥å£è°ƒç”¨éƒ½å¿…é¡»åœ¨configæ¥å£è·å¾—ç»“æœä¹‹åï¼Œconfigæ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯çš„å¼‚æ­¥æ“ä½œï¼Œæ‰€ä»¥å¦‚æœéœ€è¦åœ¨é¡µé¢åŠ è½½æ—¶å°±è°ƒç”¨ç›¸å…³æ¥å£ï¼Œåˆ™é¡»æŠŠç›¸å…³æ¥å£æ”¾åœ¨readyå‡½æ•°ä¸­è°ƒç”¨æ¥ç¡®ä¿æ­£ç¡®æ‰§è¡Œã€‚å¯¹äºç”¨æˆ·è§¦å‘æ—¶æ‰è°ƒç”¨çš„æ¥å£ï¼Œåˆ™å¯ä»¥ç›´æ¥è°ƒç”¨ï¼Œä¸éœ€è¦æ”¾åœ¨readyå‡½æ•°ä¸­ã€‚
});
</code></pre></div><ol start="4"><li>é€šè¿‡erroræ¥å£å¤„ç†å¤±è´¥éªŒè¯</li></ol> <div class="language- extra-class"><pre class="language-text"><code>wx.error(function(res){
    // configä¿¡æ¯éªŒè¯å¤±è´¥ä¼šæ‰§è¡Œerrorå‡½æ•°ï¼Œå¦‚ç­¾åè¿‡æœŸå¯¼è‡´éªŒè¯å¤±è´¥ï¼Œå…·ä½“é”™è¯¯ä¿¡æ¯å¯ä»¥æ‰“å¼€configçš„debugæ¨¡å¼æŸ¥çœ‹ï¼Œä¹Ÿå¯ä»¥åœ¨è¿”å›çš„reså‚æ•°ä¸­æŸ¥çœ‹ï¼Œå¯¹äºSPAå¯ä»¥åœ¨è¿™é‡Œæ›´æ–°ç­¾åã€‚
});
</code></pre></div><ol start="5"><li>åˆ¤æ–­å½“å‰å®¢æˆ·ç«¯ç‰ˆæœ¬æ˜¯å¦æ”¯æŒæŒ‡å®šJSæ¥å£</li></ol> <div class="language- extra-class"><pre class="language-text"><code>wx.checkJsApi({
    jsApiList: ['chooseImage'] // éœ€è¦æ£€æµ‹çš„JSæ¥å£åˆ—è¡¨
    success: function(res) {
    // ä»¥é”®å€¼å¯¹çš„å½¢å¼è¿”å›ï¼Œå¯ç”¨çš„apiå€¼trueï¼Œä¸å¯ç”¨ä¸ºfalse
    // å¦‚ï¼š{&quot;checkResult&quot;:{&quot;chooseImage&quot;:true},&quot;errMsg&quot;:&quot;checkJsApi:ok&quot;}
    },
    fail: function(err) {
    // checkJsApiæ¥å£è°ƒç”¨å¤±è´¥
    }
});
</code></pre></div><ol start="6"><li>æ¥å£è°ƒç”¨</li></ol> <div class="language- extra-class"><pre class="language-text"><code>wx.chooseImage({
    count: 1, // é»˜è®¤9
    sizeType: ['original', 'compressed'], // å¯ä»¥æŒ‡å®šæ˜¯åŸå›¾è¿˜æ˜¯å‹ç¼©å›¾ï¼Œé»˜è®¤äºŒè€…éƒ½æœ‰
    sourceType: ['album', 'camera'], // å¯ä»¥æŒ‡å®šæ¥æºæ˜¯ç›¸å†Œè¿˜æ˜¯ç›¸æœºï¼Œé»˜è®¤äºŒè€…éƒ½æœ‰
    success: function (res) {
        var localIds = res.localIds; // è¿”å›é€‰å®šç…§ç‰‡çš„æœ¬åœ°IDåˆ—è¡¨ï¼ŒlocalIdå¯ä»¥ä½œä¸ºimgæ ‡ç­¾çš„srcå±æ€§æ˜¾ç¤ºå›¾ç‰‡
    }
});
</code></pre></div><p><strong>æœ¬éƒ¨åˆ†è¦ç‰¹åˆ«æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š</strong></p> <ul><li>invalid url domainï¼šå½“å‰é¡µé¢æ‰€åœ¨åŸŸåä¸ä½¿ç”¨<strong>appid</strong>æ²¡æœ‰ç»‘å®šï¼ˆå¯åœ¨è¯¥å…¬ä¼—å·åå°çš„åº”ç”¨å¯ä¿¡åŸŸåä¸­é…ç½®å½“å‰H5é¡µé¢çš„åŸŸåï¼‰ï¼›</li> <li>invalid signatureç­¾åé”™è¯¯ï¼šå»ºè®®æŒ‰<a href="https://qydev.weixin.qq.com/wiki/index.php?title=%E5%BE%AE%E4%BF%A1JS-SDK%E6%8E%A5%E5%8F%A3#.E9.99.84.E5.BD.956-.E5.B8.B8.E8.A7.81.E9.94.99.E8.AF.AF.E5.8F.8A.E8.A7.A3.E5.86.B3.E6.96.B9.E6.B3.95" target="_blank" rel="noopener noreferrer">å¦‚ä¸‹é¡ºåºæ£€æŸ¥<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>ï¼Œä¸»è¦å¯èƒ½æ˜¯åŸŸåä¸€èˆ¬å¸¦çš„å‚æ•°ï¼Œæ‰€ä»¥åŸŸåæ¯æ¬¡éƒ½ä¸ä¸€æ ·ï¼Œå¿…é¡»åœ¨è°ƒç”¨å‰é€šè¿‡åŸŸåæ¥è·å–signatureï¼›</li> <li>æœåŠ¡ä¸Šçº¿ä¹‹åæ— æ³•è·å–jsapi_ticket,ä¸€èˆ¬æ˜¯access_tokenè°ƒç”¨æ¬¡æ•°è¿‡å¤šè¢«é™åˆ¶äº†ï¼Œéœ€è¦åœ¨æœåŠ¡ç«¯åšç¼“å­˜ï¼›</li> <li>permission deniedï¼šè¯¥å…¬ä¼—å·å·æ²¡æœ‰æƒé™ä½¿ç”¨è¿™ä¸ªJSAPIï¼ˆéƒ¨åˆ†æ¥å£éœ€è¦è®¤è¯ä¹‹åæ‰èƒ½ä½¿ç”¨ï¼‰ï¼›</li></ul> <h2 id="å¤„ç†å›¾ç‰‡æ•°æ®ä¸ºbase64"><a href="#å¤„ç†å›¾ç‰‡æ•°æ®ä¸ºbase64" aria-hidden="true" class="header-anchor">#</a> å¤„ç†å›¾ç‰‡æ•°æ®ä¸ºbase64</h2> <p><code>wx.chooseImage</code>è·å–åˆ°çš„å›¾ç‰‡ä¸ºä¸€ä¸ªä¸´æ—¶è·¯å¾„ï¼Œå¾®ä¿¡åŒæ—¶æä¾›äº†<code>wx.getLocalImgData</code>æ–¹æ³•å¯ä»¥æŠŠè·å–åˆ°çš„è·¯å¾„è½¬ä¸ºbase64æ ¼å¼çš„æ•°æ®ï¼Œè‡³æ­¤å°±å¯ä»¥è½»æ¾è®¸å¤šäº†ï¼Œä½†æ˜¯è½¬å‡ºæ¥çš„base64åœ¨androidå’ŒiOSä¸­ç¨æœ‰ä¸åŒï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„ä¸€ä¸‹ï¼š</p> <div class="language- extra-class"><pre class="language-text"><code>wx.getLocalImgData({
    localId: req.localIds[0].toString(),
    success: function (res) {
        const localData = res.localData;
        let imageBase64 = '';
        if (localData.indexOf('data:image') == 0) {
            //è‹¹æœçš„ç›´æ¥èµ‹å€¼ï¼Œé»˜è®¤ç”Ÿæˆ'data:image/jpeg;base64,'çš„å¤´éƒ¨æ‹¼æ¥
            imageBase64 = localData;
        } else {
            //æ­¤å¤„æ˜¯å®‰å“ä¸­çš„å”¯ä¸€å¾—å‘ï¼åœ¨æ‹¼æ¥å‰éœ€è¦å¯¹localDataè¿›è¡Œæ¢è¡Œç¬¦çš„å…¨å±€æ›¿æ¢
            //æ­¤æ—¶ä¸€ä¸ªæ­£å¸¸çš„base64å›¾ç‰‡è·¯å¾„å°±å®Œç¾ç”Ÿæˆèµ‹å€¼åˆ°imgçš„srcä¸­äº†
            imageBase64 = 'data:image/jpeg;base64,' + localData.replace(/\n/g, '');
        }
    }
});
</code></pre></div><h2 id="ä¸Šä¼ å›¾ç‰‡"><a href="#ä¸Šä¼ å›¾ç‰‡" aria-hidden="true" class="header-anchor">#</a> ä¸Šä¼ å›¾ç‰‡</h2> <blockquote><p>è·å–åˆ°å›¾ç‰‡çš„base64æ•°æ®ä¹‹åå…¶å®æˆ‘ä»¬å°±å¯ä»¥ä¸ºæ‰€æ¬²ä¸ºäº†ï¼Œä¸éœ€è¦ä½¿ç”¨<code>wx.uploadImage</code>å’Œ<code>wx.downloadImage</code>äº†ï¼Œä¸ä»…éœ€è¦éº»çƒ¦çš„ä¸Šä¼ åˆ°å¾®ä¿¡æœåŠ¡å™¨ï¼Œè¿˜æœ‰ä¸‰å¤©çš„æ—¶é—´é™åˆ¶åè€Œå¢åŠ äº†æˆæœ¬ï¼Œæœ€å¥½çš„æ–¹å¼å°±æ˜¯ç›´æ¥ä¸Šä¼ è‡³æˆ‘ä»¬è‡ªå·±çš„æœåŠ¡å™¨ã€‚</p></blockquote> <p>ä¸€èˆ¬ä¸æœåŠ¡ç«¯äº¤äº’çš„è¿™ç§æ–‡ä»¶ç±»å‹ä¸€èˆ¬é‡‡ç”¨<strong>è¡¨å•æäº¤--multipart/form-data</strong>çš„æ–¹å¼ï¼Œè¿™å°±è¦æ±‚æˆ‘ä»¬ç†Ÿæ‚‰ä¼ è¾“<a href="https://www.cnblogs.com/shanyou/archive/2013/06/07/3123155.html" target="_blank" rel="noopener noreferrer"><strong>form-data</strong><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>çš„æ•°æ®äº¤äº’ï¼Œæ‰€ä»¥éœ€è¦æŠŠåˆšæ‰è·å–åˆ°çš„base64è½¬ä¸ºå¯postçš„äºŒè¿›åˆ¶æ•°æ®ï¼ŒJavaScriptæä¾›äº†åŸç”Ÿçš„<code>atob/btoa</code>ç”¨æ¥å¯¹base64è¿›è¡Œç¼–ç å’Œè§£ç ï¼›</p> <div class="language- extra-class"><pre class="language-text"><code>base64ToBlob(dataurl) {
    let arr = dataurl.split(',');
    let mime = arr[0].match(/:(.*?);/)[1];
    let bstr = atob(arr[1]);
    let n = bstr.length;
    let u8arr = new Uint8Array(n);
    while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
    }
    return new Blob([u8arr], { type: mime });
}
</code></pre></div><p>ok,å¤„ç†å¥½å¯äº¤äº’çš„æ•°æ®å°±å¯ä»¥ä¸Šä¼ åˆ°è‡ªå·±çš„æœåŠ¡å™¨äº†ï¼Œä¹‹åç›¸å½“äºæ™®é€šH5é¡µé¢çš„å›¾ç‰‡äº¤äº’äº†,å¯ä¸Šä¼ å¯ä¸‹è½½ğŸ˜„</p> <div class="language- extra-class"><pre class="language-text"><code>let param = new FormData();
param.append('headPic', imageData);
this.$http.post('/upload.json', {
    headers: {
        'Content-Type': 'multipart/form-data',
    },
    params: param,
}).then(res =&gt; {
    console.log('ä¸Šä¼ æˆåŠŸ', res);
});
</code></pre></div><h2 id="å®Œæ•´ä»£ç "><a href="#å®Œæ•´ä»£ç " aria-hidden="true" class="header-anchor">#</a> å®Œæ•´ä»£ç </h2> <p>ç»ˆäºã€‚ã€‚ã€‚å¯ä»¥å‘Šä¸€æ®µè½äº†ï¼Œè‡³æ­¤å°ç¨‹åºçš„<code>web-view</code>é‡ŒæˆåŠŸä½¿ç”¨äº†<code>wx.chooseImage</code>,ä¸‹é¢æŠŠå®Œæ•´ä»£ç è´´å‡ºæ¥ï¼Œæ•¬è¯·å‚è€ƒğŸ˜„</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;template&gt;
    &lt;div class=&quot;card-avatar&quot;&gt;
      &lt;img
        :src=&quot;avatarUrl&quot;
      &gt;
      &lt;div
        class=&quot;choose-image&quot;
        @click=&quot;chooseImage&quot;
      /&gt;
    &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
import wx from 'weixin-js-sdk';
const imgUrl = require('../../common/assets/images/default-avatar.png')ï¼›

export default {
  name: 'Card',
  components: {
  },
  props: {
  },
  data() {
    return {
      avatarUrl: imgUrl,
    };
  },
  computed: {
  },
  watch: {
  },
  mounted() {
    this.getWxConfigDatas();
  },
  methods: {
    getWxConfigDatas() {
      const params = {
        checkCode: getUrlParams().checkCode,  // ä»åœ°å€æ è·å–checkCodeç”¨äºæ ¡éªŒsignature
      };
      this.$http.get('/signature.json', { params }).then(res =&gt; {
        if (res.content.data &amp;&amp; res.content.data.signature) {
          this.registereWxApi(res.content.data.signature);
        }
      });
    },
    registereWxApi(data) {
      wx.config({
        // debug: true,
        jsApiList: ['chooseImage', 'getLocalImgData'],
        appId: data.appId,
        timestamp: data.timestamp,
        nonceStr: data.nonceStr,
        signature: data.signature,
      });
    },
    chooseImage() {
      let that = this;
      if (window.__wxjs_environment === 'miniprogram') {
        wx.miniProgram.getEnv(function(res) {
          if (res.miniprogram) {
            wx.checkJsApi({
              jsApiList: ['chooseImage', 'getLocalImgData'],
              success: function(res) {
                if (res.checkResult.chooseImage) {
                  wx.chooseImage({
                    count: 1,
                    sizeType: ['compressed'],
                    sourceType: ['album', 'camera'],
                    success: function(req) {
                      wx.getLocalImgData({
                        localId: req.localIds[0].toString(),
                        success: function (res) {
                          const localData = res.localData;
                          let imageBase64 = '';
                          if (localData.indexOf('data:image') == 0) {
                            //è‹¹æœçš„ç›´æ¥èµ‹å€¼ï¼Œé»˜è®¤ç”Ÿæˆ'data:image/jpeg;base64,'çš„å¤´éƒ¨æ‹¼æ¥
                            imageBase64 = localData;
                          } else {
                            //æ­¤å¤„æ˜¯å®‰å“ä¸­çš„å”¯ä¸€å¾—å‘ï¼åœ¨æ‹¼æ¥å‰éœ€è¦å¯¹localDataè¿›è¡Œæ¢è¡Œç¬¦çš„å…¨å±€æ›¿æ¢
                            //æ­¤æ—¶ä¸€ä¸ªæ­£å¸¸çš„base64å›¾ç‰‡è·¯å¾„å°±å®Œç¾ç”Ÿæˆèµ‹å€¼åˆ°imgçš„srcä¸­äº†
                            imageBase64 = 'data:image/jpeg;base64,' + localData.replace(/\n/g, '');
                          }
                          that.avatarUrl = imageBase64;
                          that.handleAvatar(that.dataURLtoBlob(imageBase64));
                        }
                      });
                    },
                    fail() {
                      that.$toast.show({
                        type: 'text',
                        text: 'é€‰æ‹©å¤´åƒå¤±è´¥ï¼',
                      });
                    }
                  });
                } else {
                  that.$toast.show({
                    type: 'text',
                    text: 'æš‚ä¸æ”¯æŒä¿®æ”¹å¤´åƒï¼',
                  });
                }
              },
              fail: function() {
                that.$toast.show({
                  type: 'text',
                  text: 'æš‚ä¸æ”¯æŒä¿®æ”¹å¤´åƒï¼',
                });
              },
            });
          } else {
            that.lgBridgeChooseImage();
          }
        });
      } else {
        that.lgBridgeChooseImage();
      }
    },
    handleAvatar(imageData) {
        let that = this;
        let param = new FormData();
        param.append('headPic', imageData);
        that.$http.post('/upload.json', {
            headers: {
                'Content-Type': 'multipart/form-data',
            },
        params: param,
        }).then(res =&gt; {
        if (parseInt(res.state, 10) === 1) {
            that.$toast.show({
                type: 'success',
                text: 'ä¸Šä¼ æˆåŠŸï¼',
            });
          that.avatarUrl = res.content &amp;&amp; res.content.data &amp;&amp; res.content.data.url;
        }
      });
    },
    dataURLtoBlob(dataurl) {
      let arr = dataurl.split(',');
      let mime = arr[0].match(/:(.*?);/)[1];
      let bstr = atob(arr[1]);
      let n = bstr.length;
      let u8arr = new Uint8Array(n);
      while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
      }
      return new Blob([u8arr], { type: mime });
    }
  }
};
&lt;/script&gt;

&lt;style lang=&quot;less&quot; scoped&gt;
.card-avatar {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 180px;
    height: 180px;
    border-radius: 100%;
    overflow: hidden;
    img {
      width: 100%;
      height: 100%;
    }
    .choose-image, input {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
    }
}
&lt;/style&gt;
</code></pre></div><p>è¿™ä¸ªéœ€æ±‚åšä¸‹æ¥å‚è€ƒäº†ä¸å°‘æ–‡ç« ï¼Œå…¶å®å¤§å¤šéƒ½æ˜¯ä¸€çŸ¥åŠè§£ï¼Œæ¯ä¸ªäººé‡åˆ°çš„é—®é¢˜ä¸åŒï¼Œè¿™ç¯‡æ–‡ç« å¯ä»¥è¯´å½»åº•è§£å†³<code>wx.chooseImage</code>çš„å„ç§ç–‘éš¾æ‚ç—‡ï¼Œä¸€æ­¥åˆ°ä½,å› æ­¤è¶ç€ä»Šå¤©ä¼‘æ¯æŠŠæ•´ä¸ªè¿‡ç¨‹è®°å½•ä¸‹æ¥ï¼Œåˆ†äº«ç»™ä¹‹åæœ‰éœ€è¦çš„å„ä½åŒè¡Œï¼</p></div> <div class="content page-nav"><p class="inner"><span class="prev">â†
          <a href="/blog/blog/ios-keyboard-blank.html" class="prev">ä¸€æ–‡å½»åº•è§£å†³iOSä¸­é”®ç›˜å›è½åç•™ç™½é—®é¢˜</a></span> <span class="next"><a href="/blog/blog/javascript-algorithm-1.html">å‰ç«¯å°ç™½çš„ç®—æ³•ä¹‹è·¯</a>â†’
        </span></p></div></div> <!----></div> <div class="tool-group"><!----></div></div></div> <footer class="footer"><span>å¦‚æœè¯´äººç”Ÿæ˜¯ä¸€åœºæ—…è¡Œï¼Œè€Œæˆ‘æ˜¯è¿™åœºæ—…è¡Œçš„ä¸»äºº!</span></footer></div><div class="global-ui"><!----></div></div>
    <script src="/blog/assets/js/app.426b1919.js" defer></script><script src="/blog/assets/js/8.723e2475.js" defer></script><script src="/blog/assets/js/3.79418191.js" defer></script><script src="/blog/assets/js/16.d48bf774.js" defer></script><script src="/blog/assets/js/19.ff47a288.js" defer></script><script src="/blog/assets/js/13.7908793c.js" defer></script><script src="/blog/assets/js/68.f115d1bc.js" defer></script><script src="/blog/assets/js/5.da195e96.js" defer></script>
  </body>
</html>
